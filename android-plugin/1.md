# Android æ’ä»¶åŒ–

>æœ¬äººæ‰€æœ‰æ–‡ç« ç¦æ­¢ä»»ä½•å½¢å¼çš„è½¬è½½

## å‰æ

åšäº†ä¸€ä¸ªæ–‡ä»¶å¤¹ç®¡ç†åº”ç”¨**giant-explorer**ï¼Œé“¾æ¥[https://github.com/storytellerF/common-ui-list-structure](https://github.com/storytellerF/common-ui-list-structure)ï¼Œåœ¨å®ŒæˆåŸºç¡€åŠŸèƒ½ä¹‹åï¼Œå¸Œæœ›å‰©ä¸‹çš„åŠŸèƒ½éƒ½é€šè¿‡æ’ä»¶å®Œæˆã€‚

**æ’ä»¶æœ‰åˆ«äºçƒ­ä¿®å¤**ï¼Œçƒ­ä¿®å¤ä¸å¸Œæœ›çŸ¥é“ç”¨æˆ·æ„ŸçŸ¥åˆ°è¿›è¡Œäº†çƒ­ä¿®å¤ï¼Œè€Œæ’ä»¶éœ€è¦ç”¨æˆ·æ‰‹åŠ¨å®‰è£…æˆ–è€…ç¡®è®¤ï¼Œå¿…è¦æƒ…å†µä¸‹è¿˜éœ€è¦ç”¨æˆ·åŒæ„ç›¸å…³æƒé™å’Œæ”¿ç­–ã€‚

æ’ä»¶åŒ–æœ‰ä¸‰ä¸ªé€‰æ‹©ï¼š

1. å®‰è£…åçš„apk

    ä¸æ­£å¸¸çš„app æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥åšä¸€äº›ç‰¹æ®Šæ“ä½œï¼Œè®©ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©ä½¿ç”¨æŸä¸ªæ’ä»¶æ‰“å¼€ï¼Œè€Œä¸æ˜¯å¼¹å‡ºæ¥ä¸€ä¸ªé€‰æ‹©å™¨ã€‚

2. æœªå®‰è£…çš„apk

    è§£æclass ååœ¨å½“å‰app è¿›ç¨‹å®ä¾‹åŒ–ã€‚æœ¬æ¥çš„æƒ³æ³•æ˜¯åŠ è½½ä¸€ä¸ªaaræ–‡ä»¶ï¼Œä¸è¿‡aar æ–‡ä»¶è¿˜ä¸èƒ½è¢«class loder åŠ è½½ï¼Œé‚æ”¾å¼ƒã€‚

3. å‰ç«¯æ’ä»¶

    æœ‰äººä¼šè¯´android ä¹Ÿç®—æ˜¯ä¸€å®šçš„å‰ç«¯äº†ï¼Œå…¶å®è¿™ç§é—®é¢˜ä¸å¤ªå¥½è®¨è®ºï¼ŒAndroid ä¹Ÿå¯ä»¥å¼€å‘æœåŠ¡å™¨åº”ç”¨ï¼Œæµè§ˆå™¨ä¹Ÿå¯ä»¥æ‰§è¡Œnode.jsçš„ä»£ç ï¼Œæ‰€ä»¥åé¢è¿˜æ˜¯ä½¿ç”¨ç¬¬å‡ ç§æ’ä»¶æ¥è¿›è¡Œæè¿°ã€‚

## æ­£é¢˜

1. ç¬¬ä¸€ç§æ’ä»¶

    åœ¨Android ä¸­ï¼Œä¸åŒçš„app ä¹‹é—´éœ€è¦è¿›ç¨‹é—´é€šä¿¡ï¼Œå› ä¸ºæœ¬æ¥å®¿ä¸»åº”ç”¨å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶ç®¡ç†åº”ç”¨ï¼Œæ‰€ä»¥é¡ºå…¶è‡ªç„¶å°±ä½¿ç”¨äº†`content provider` ä½œä¸ºè¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼ã€‚

    å®¿ä¸»åº”ç”¨æ„å»ºä¸€ä¸ªuriï¼Œä¼ é€’ç»™æ’ä»¶ï¼Œæ’ä»¶é€šè¿‡`contentResolver.openFileDescriptor(u, "r")` è·å–`fileDescriptor` (æŸäº›ä»£ç ä¸­ä¼šå†™ä½œfdï¼Œè¿™æ˜¯Linux ä¸­çš„æ¦‚å¿µï¼Œç›¸å½“äºid)ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡è¿™ä¸ªfd è·å–æ–‡ä»¶å†…å®¹ã€‚æ¯”å¦‚æˆ‘ä»¬è·å–å›¾ç‰‡çš„fd ç„¶ååŠ è½½åˆ°ImageView ä¸Šã€‚

    ```kotlin
    val fileDescriptor = parcelFileDescriptor?.fileDescriptor ?: return
    val decodeStream = BitmapFactory.decodeFileDescriptor(fileDescriptor)
    findViewById.setImageBitmap(decodeStream)
    ```

    ç„¶ååœ¨æ’ä»¶ä¸­è®¾ç½®ä¸€ä¸ªIntent Filterï¼Œç”¨äºå®¿ä¸»åº”ç”¨æœç´¢ï¼Œæ ‡æ˜è‡ªå·±å¯ä»¥ä½œä¸ºæ’ä»¶è¿è¡Œã€‚

    ```xml
    <intent-filter>

        <action android:name="com.storyteller_f.action.giant_explorer.PLUGIN" />
        <category android:name="android.intent.category.DEFAULT" />
        <data
            android:mimeType="image/*"
            android:scheme="content" />
    </intent-filter>

    <meta-data
        android:name="group"
        android:value="view" />
    <meta-data
        android:name="title"
        android:value="@string/app_name" />
    ```

    ä¸‹é¢çš„meta-data ä½ å¯èƒ½ä¼šæ¯”è¾ƒå¥‡æ€ªï¼Œå…¶å®ä»–ä»¬æ˜¯ç”¨æ¥æ·»åŠ ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œå› ä¸ºå±•ç¤ºå‡ºæ¥çš„æŒ‰é’®æ€»è¦æœ‰ä¸ªåå­—ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡è¿™ç§æ–¹å¼æŒ‡æ˜ï¼Œè¿™æ ·ç”šè‡³ä¹Ÿæœ‰i18n åŠŸèƒ½ï¼ŒçœŸä¸é”™ã€‚

    ç„¶åæ˜¯å®¿ä¸»åº”ç”¨æœç´¢

    ```kotlin
    val activities = requireContext().packageManager.queryIntentActivities(intent, PackageManager.MATCH_DEFAULT_ONLY or PackageManager.GET_META_DATA)
    activities.forEach {
        val activityInfo = it?.activityInfo ?: return@forEach
        val groups = activityInfo.metaData?.getString("group")?.split("/") ?: return@forEach
        val title = activityInfo.metaData?.getString("title") ?: return@forEach
        this.menu.loopAdd(groups).add(title).setOnMenuItemClickListener {
            intent.setPackage(requireContext().packageName).component = ComponentName(activityInfo.packageName, activityInfo.name)
            startActivity(intent)
            return@setOnMenuItemClickListener true
        }
    }

    private fun Menu.loopAdd(strings: List<String>): Menu {
        return strings.fold(this) { t, e ->
            t.addSubMenu(e)
        }
    }
    ```

    è¿™æ®µä»£ç æ˜¯ä»é¡¹ç›®ä¸­å¤åˆ¶çš„ï¼Œæ‰€ä»¥è¿˜æ˜¯æŒºé•¿çš„ã€‚

    é¦–å…ˆç¬¬ä¸€è¡Œè·å–èƒ½å¤Ÿå¤„ç†ç›¸åº”çš„mimeType çš„activityã€‚`PackageManager.GET_META_DATA` æ˜¯å¿…é¡»çš„ï¼Œä¸ç„¶æˆ‘ä»¬ä¸èƒ½è·å¾—é‚£ä¸ªmeta-dataã€‚

    ç„¶åæ˜¯é€šè¿‡loopAdd è¿­ä»£æ·»åŠ menuï¼Œfold å¯ä»¥éå¸¸æ–¹ä¾¿æˆ‘ä»¬å®ç°è¿­ä»£åŠŸèƒ½ï¼Œä½†ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å»å†™ï¼Œæ¯•ç«Ÿå‡½æ•°å¼ç¼–ç¨‹ã€‚ç¬¬ä¸€æ¬¡çš„t æ˜¯æˆ‘ä»¬ä¼ å…¥çš„thisï¼Œä¸‹ä¸€æ¬¡çš„t å°±ä¸æ˜¯this äº†ï¼Œè€Œæ˜¯t.addSubMenu(e) çš„è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ªèœå•ï¼Œ greatğŸ‘Œã€‚

    æœ€åä¸€æ­¥

    ```xml
    <queries>
        <intent>
            <action android:name="com.storyteller_f.action.giant_explorer.PLUGIN" />

            <category android:name="android.intent.category.DEFAULT" />

            <data
                android:mimeType="*/*"
                android:scheme="content" />
        </intent>
    </queries>
    ```

    è°·æ­Œä¸å…è®¸ä½¿ç”¨`<uses-permission android:name="android.permission.QUERY_ALL_PACKAGES"/>` è¿™æ ·çš„å®½æ³›çš„æƒé™ï¼Œå¿…é¡»æ˜ç¡®æŒ‡å®šæˆ‘ä»¬éœ€è¦çš„æŸ¥è¯¢çš„åŒ…ã€‚

2. ç¬¬äºŒç§æ’ä»¶

    å¦‚æœactivity æ²¡æœ‰åœ¨manifest ä¸­å£°æ˜ï¼Œå®‰å“ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå¾ˆæ˜¾ç„¶æˆ‘ä»¬çš„æ’ä»¶çš„activity æ˜¯æ²¡æœ‰åœ¨manifest ä¸­å£°æ˜ã€‚

    ä½ å¯èƒ½ä¼šè¯´æˆ‘ä»¬å¯ä»¥ä½¿ç”¨hook æ¬ºéª—ç³»ç»Ÿï¼Œè€Œä¸”æœ‰å¾ˆå¤šçš„åº“ï¼Œéƒ½ä¸ç”¨è‡ªå·±å†™ï¼Œä½†æ˜¯ä½¿ç”¨hook çš„æ–¹å¼ä¼šä½¿æˆ‘ä»¬çš„app å˜å¾—ä¸ç¨³å®šï¼Œåœ¨æˆ‘çœ‹æ¥å±äºä¸‹ç­–ï¼Œæ˜¯åœ¨æ²¡æœ‰åŠæ³•çš„æ—¶å€™æ‰ä½¿ç”¨ã€‚

    ğŸ¤”

    é‚£ä¹ˆæˆ‘ä»¬é¡ºä¸”è‡ªç„¶å°±ä¼šæƒ³åˆ°ä½¿ç”¨Fragment ä½œä¸ºæˆ‘ä»¬çš„æ’ä»¶è½½ä½“ï¼Œå³æ²¡æœ‰hookï¼Œä¹Ÿä¸éœ€è¦å¤„ç†ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿä¸éœ€è¦è®©æˆ‘ä»¬æ’ä»¶ç»§æ‰¿ä¸€ä¸ªå¥‡å¥‡æ€ªæ€ªçš„activityï¼Œå®Œå®Œå…¨å…¨ç¬¦åˆè°·æ­Œçš„è®¾è®¡ï¼Œä¹Ÿç¬¦åˆæœ¬äººç¼–ç¨‹åŸåˆ™ï¼Œå²‚ä¸ç¾å“‰ã€‚

    ä½¿ç”¨DexClassLoader åŠ è½½ä¸€ä¸ªapk æ–‡ä»¶ï¼Œæ­¤class loader ä¼šè‡ªåŠ¨åŠ è½½dex æ–‡ä»¶ï¼Œå³ä½¿è¿™ä¸ªapk ä¸­æœ‰å¤šä¸ªdex ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œï¼Œgreatã€‚

    ```kotlin
    val dexClassLoader = DexClassLoader(file.absolutePath, null, null, classLoader)

    val loadClass = dexClassLoader.loadClass("com.storyteller_f.yue_plugin.YueFragment")
    val newInstance = loadClass.newInstance()
    ```

    ç„¶åæˆ‘ä»¬è¿˜éœ€è¦å¤„ç†resouncesï¼ŒAndroid çš„æ‰€æœ‰èµ„æºéƒ½æ˜¯é€šè¿‡`Resources` è·å–ï¼Œè€Œä¸”Fragment æ˜¯ç›´æ¥ä½¿ç”¨çš„å®¿ä¸»activity çš„Resourcesï¼Œå†ä¸€æ¬¡çš„greatã€‚

    ```kotlin
    /**
     * Return <code>requireActivity().getResources()</code>.
     */
    @NonNull
    final public Resources getResources() {
        return requireContext().getResources();
    }
    ```

    æˆ‘ä»¬ä½¿ç”¨æ‡’åŠ è½½çš„æ–¹å¼åŠ è½½æ’ä»¶çš„èµ„æºã€‚è¿™ä¸ªèµ„æºåœ¨apk ä¸­ï¼Œè™½ç„¶æˆ‘ä»¬æ²¡æœ‰å®‰è£…å®ƒã€‚

    ```kotlin
    private val pluginResources by lazy {
        val packageArchiveInfo = packageManager.getPackageArchiveInfo(File(cacheDir, "app-debug.apk").absolutePath, 0)
        val applicationInfo = packageArchiveInfo?.applicationInfo
        if (applicationInfo != null)
            packageManager.getResourcesForApplication(applicationInfo)
        else null
    }
    ```

    ç„¶åæ˜¯æˆ‘ä»¬çš„å®¿ä¸»activity

    ```kotlin
    override fun getResources(): Resources {
        val stackTrace = Thread.currentThread().stackTrace
        val listOf = listOf("com.storyteller_f.yue_plugin.ImageViewFragment", "com.storyteller_f.yue_plugin.YueFragment")
        if (stackTrace.any {
                listOf.contains(it.className)
            }) {
            return pluginResources!!
        }
        return super.getResources()
    }
    ```

    æˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨try-catch çš„æ–¹å¼åœ¨æ‰¾ä¸åˆ°èµ„æºæ—¶ä»æ’ä»¶ä¸­åŠ è½½ï¼Œæˆ‘ä»¬ç›´æ¥åˆ¤æ–­å‘èµ·æ­¤æ¬¡è°ƒç”¨æ—¶æ’ä»¶è¿˜æ˜¯æ­£å¸¸çš„å®¿ä¸»activityï¼Œæ¯•ç«ŸAndroid æ²¡æœ‰å¯ç”¨åˆ‡æ¢çº¿ç¨‹å»è·å–`Resources`ã€‚

    æ„Ÿè§‰å®‰å“çš„è®¾è®¡å°±æ˜¯ä¸ºäº†æˆ‘ä»Šå¤©å®ç°æ’ä»¶åŠŸèƒ½å•Šï¼ˆå¼€ä¸ªç©ç¬‘ï¼‰ã€‚

3. ç¬¬ä¸‰ç§æ’ä»¶

    å®‰å“çš„WebView å…è®¸æˆ‘ä»¬ä½¿ç”¨`addJavascriptInterface` è®©`JavaScript` è°ƒç”¨å®‰å“çš„ä»£ç ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ç¬¬ä¸‰ç§æ’ä»¶å­˜åœ¨çš„ä¸»è¦åŸºç¡€ã€‚æ¯•ç«Ÿä¸èƒ½ä¸ºäº†ä¸€ä¸ªæ’ä»¶åŠŸèƒ½æŠŠchromium æ”¾è¿›æ¥ã€‚

    åŸºç¡€çš„è®¾ç½®ä¸€ä¸ªWebView å°±ä¸è®²äº†ã€‚

    ```kotlin
    val pluginManager = object : GiantExplorerPluginManager {

        @JavascriptInterface
        override fun fileInputStream(path: String) = getFileInstance(path, this@WebViewPluginActivity).fileInputStream

        @JavascriptInterface
        override fun fileOutputStream(path: String) = getFileInstance(path, this@WebViewPluginActivity).fileOutputStream

        @JavascriptInterface
        override fun listFiles(path: String): List<String> {
            return getFileInstance(path, this@WebViewPluginActivity).listSafe().let { filesAndDirectories ->
                filesAndDirectories.files.map {
                    it.fullPath
                } + filesAndDirectories.directories.map {
                    it.fullPath
                }
            }
        }

        @JavascriptInterface
        fun base64(path: String): String {
            val readBytes = fileInputStream(path).readBytes()
            return Base64.encodeToString(readBytes, Base64.NO_WRAP)
        }

    }
    webView.addJavascriptInterface(pluginManager, "plugin")

    ```

    å‰ä¸‰ä¸ªæ–¹æ³•æ˜¯ç¬¬äºŒç§æ’ä»¶ä¹Ÿéœ€è¦ç”¨çš„ï¼Œæœ€åä¸€ä¸ªbase64(path: String) æ˜¯ï¼Œç¬¬ä¸‰ç§æ’ä»¶ç‹¬æœ‰çš„ï¼Œç”¨æ¥ç»™JavaScript å‘é€æ–‡ä»¶å†…å®¹ã€‚

    æ¼”ç¤ºä¸€ä¸‹åœ¨æ’ä»¶ä¸­æ˜¾ç¤ºæˆ‘ä»¬çš„å›¾ç‰‡ï¼š

    ```html
    <html>
    <body>
    <img id="ci" src="">
    <script>
        document.write(file.fullPath())
        let ele = document.getElementById("ci")
        ele.src = "data:image/png;base64," + plugin.base64(file.fullPath())

    </script>
    </body>
    </html>
    ```

## æœ€å

å†™ä»£ç ä¹Ÿè¦æœ‰æ‰€ä¸ºï¼Œæœ‰æ‰€ä¸ä¸ºã€‚å†™å®Œåšå®¢ï¼Œå»çœ‹ä¸‰ä½“ï¼Œgreatã€‚
